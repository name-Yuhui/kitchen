{% extends 'base.html' %}
{% block son_page_css %}
{% load static %}
<style>
    * {
        padding: 0 0;
        margin: 0 0;
    }

    section {
        height: 100%;
        display: block;
        width: 1000px;
        margin: 0 auto;
    }

    section:after {
        content: '';
        display: block;
        clear: both;
    }

    .tt td {
        color: #28a745;
        font-weight: 700;
        background-color: #f1f1f1;
        width: 100%;
    }

    .publish_table tbody tr:nth-of-type(even) td {
        width: 50%;
    }

    .append {
        font-size: 12px;
        color: #de3a16;
        width: 70px;
        text-align: center;
        height: 100%;
        display: inline-block;
    }
</style>

{% endblock %}
{% block section %}
<section>
    <form action="/publish/" method="post">
        <table class="publish_table">
            <tbody>
            <tr class="tt">
                <td>æˆå“å›¾</td>
            </tr>
            <tr>
                <td><input type="file" id="main_img" name="main_img"></td>
            </tr>
            <tr class="tt">
                <td>æ ‡é¢˜</td>
            </tr>
            <tr>
                <td colspan="2"><input id="title" type="text" name="title"></td>
            </tr>
            <tr class="tt">
                <td>ç±»å‹</td>
            </tr>
            <tr>
                <td colspan="2"><input id="type" type="text" name="tpye"></td>
            </tr>
            <tr class="tt">
                <td>æè¿°</td>
            </tr>
            <tr>
                <td colspan="2"><textarea id="desc" style="width: 100%" placeholder="ç®€å•ä»·ç»ä½ çš„èœè°±å§ğŸ˜„"
                                          name="desc"></textarea></td>
            </tr>
            <tr id="usefood" class="tt">
                <td>ç”¨æ–™ <a href="javascript:(0)" class="append">æ·»åŠ ç”¨æ–™</a></td>
            </tr>
            <tr class="m">
                <td><input type="text" name="k" placeholder="é…±æ²¹"></td>
                <td><input type="text" name="v" placeholder="ä¸€å‹º"></td>
            </tr>
            <tr class="tt">
                <td>æ­¥éª¤ <a href="javascript:(0)" class="append">æ·»åŠ æ­¥éª¤</a></td>
            </tr>
            <tr class="s">
                <td><input type="text" name=""></td>
                <td><input type="file" name=""></td>
            </tr>
            </tbody>

            <tfoot>
            <tr>
                <td colspan="2"><a href="javascript:(0)" id="submit">æäº¤</a></td>
            </tr>
            </tfoot>

            </tr>
        </table>
    </form>
</section>
{% endblock %}
{% block js %}

<!--<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>-->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.js"></script>

<script>
    // æ·»åŠ æ ‡ç­¾
    $(".publish_table tr:even td").attr("colspan", '2')
    $(".append:first").click(function () {
        var strr = '<tr class="m"><td><input type="text" name="" placeholder="é…±æ²¹"></td><td><input type="text" name="" placeholder="ä¸€å‹º"></td>'
        // console.log($(".tt:last").text())
        // $(".tt:last").prependTo($(strr))
        $(".tt:last").before($(strr))
    })
    $(".append:last").click(function () {
        var strr = '<tr class="s"><td><input type="text"  name="" ></td><td><input type="file" name="" ></td></tr>'
        // $(".tt:last").prependTo($(strr))
        $("tbody").append($(strr))
    })

    // æäº¤è¡¨å•
    $("#submit").click(function () {
        var title = $("#title").val()
        var type = $("#type").val()
        var desc = $("#desc").val()
        // å›¾ç‰‡è·å–
        var main_img = ($("#main_img")[0].files[0])
        let form = new FormData();//è¡¨å•æ•°æ®æ ¼å¼


        // console.log(main_img, title, type, desc)
        var use_list = [];
        $(".m").each(function (index, currentValue) {
            var name = $(currentValue).find($('td:nth-child(1) input')).val()
            var g = $(currentValue).find($('td:nth-child(2) input')).val()
            var s = {"name": name, "g": g}
            use_list.push(s)
        })

        var steps_list = [];
        $(".s").each(function (index, currentValue) {
            var k = $(currentValue).find($('td:nth-child(1) input')).val()
            var img_file = $(currentValue).find($('td:nth-child(2) input'))[0].files[0]
            var s = {"ord": index + 1, "cont": k,}

            steps_list.push(s)
            form.append(index+1,img_file)

        })
        console.log(use_list)
        form.append("title",title)
        form.append("type",type)
        form.append("desc",desc)
        form.append("steps_list",JSON.stringify(steps_list))
        form.append("use_list",JSON.stringify(use_list))
        form.append("main_img",main_img)
        console.log(form)
        //    ajax
        $.ajax({
            url: "/publish/",			//è¯·æ±‚çš„url
            method: "post",				//è¯·æ±‚æäº¤çš„æ–¹å¼
            data: form,	//è¯·æ±‚ä¼ é€’çš„å‚æ•°
            contentType: false,//jqueryæœ‰é»˜è®¤çš„application/json
            processData: false,//ajaxä¼šåšæ•°æ®å¤„ç† falseæ˜¯ä¸å¤„ç†
            success: function (data, status) {//å›è°ƒå‡½æ•° dataæ˜¯å†™å›åœ¨ç¼“å­˜ä¸­çš„æ•°æ®ï¼Œstatusæ˜¯è¿è¡ŒçŠ¶æ€
                console.log("ok")
            },
            error: function () {			//å½“å‡ºç°é”™è¯¯æ‰§è¡Œçš„å›è°ƒå‡½æ•°
                alert("å‡ºé”™äº†");
            },
            dataType: "text"				//é¢„æœŸæœåŠ¡å™¨è¿”å›çš„æ•°æ®ç±»å‹,å¸¸ç”¨json
        });
    })
</script>

{% endblock %}